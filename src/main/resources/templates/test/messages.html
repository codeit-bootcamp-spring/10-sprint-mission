<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>메시지 관리 테스트</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .msg-img { max-width: 150px; display: block; margin-top: 5px; }
    </style>
</head>
<body class="p-4">
<div class="container">
    <nav class="mb-4">
        <a href="/test/users" class="btn btn-secondary">사용자 관리</a>
        <a href="/test/channels" class="btn btn-secondary">채널 관리</a>
        <a href="/test/messages" class="btn btn-primary">메시지 관리</a>
    </nav>

    <h2>3. 메시지 & 파일 관리</h2>

    <div class="row mb-3">
        <div class="col-md-6">
            <label>보내는 사람 (User ID)</label>
            <input type="text" id="authorId" class="form-control" placeholder="User UUID">
        </div>
        <div class="col-md-6">
            <label>대상 채널 (Channel ID)</label>
            <div class="input-group">
                <input type="text" id="targetChannelId" class="form-control" placeholder="Channel UUID">
                <button class="btn btn-info" onclick="loadMessages()">메시지 조회</button>
            </div>
        </div>
    </div>

    <div class="card p-3 mb-4">
        <h5>메시지 전송 (POST /api/messages)</h5>
        <form id="msgForm">
            <textarea id="msgContent" class="form-control mb-2" placeholder="내용 입력"></textarea>
            <input type="file" id="msgFiles" class="form-control mb-2" multiple>
            <button type="button" class="btn btn-primary" onclick="sendMessage()">전송</button>
        </form>
    </div>

    <div class="card p-3">
        <h5>메시지 목록 (GET /api/messages?channel-id=...)</h5>
        <div id="messageList" class="mt-3">
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api';
    document.getElementById('authorId').value = localStorage.getItem('myUserId') || '';

    async function sendMessage() {
        const formData = new FormData();
        const requestDto = {
            content: document.getElementById('msgContent').value,
            authorId: document.getElementById('authorId').value,
            channelId: document.getElementById('targetChannelId').value
        };

        formData.append('request', new Blob([JSON.stringify(requestDto)], {type: "application/json"}));

        const fileInput = document.getElementById('msgFiles');
        for (let i = 0; i < fileInput.files.length; i++) {
            formData.append('attachments', fileInput.files[i]);
        }

        try {
            const res = await fetch(`${API_BASE}/messages`, { method: 'POST', body: formData });
            if(res.ok) {
                document.getElementById('msgContent').value = '';
                document.getElementById('msgFiles').value = '';
                loadMessages();
            } else {
                alert('전송 실패: ' + await res.text());
            }
        } catch(e) { console.error(e); }
    }

    async function loadMessages() {
        const channelId = document.getElementById('targetChannelId').value;
        if(!channelId) return;

        const res = await fetch(`${API_BASE}/messages?channel-id=${channelId}`);
        const messages = await res.json();

        const container = document.getElementById('messageList');
        container.innerHTML = '';

        for (const msg of messages) {
            let attachmentsHtml = '';
            if(msg.attachmentIds && msg.attachmentIds.length > 0) {
                for(const fileId of msg.attachmentIds) {
                    const fileRes = await fetch(`${API_BASE}/binary-contents/find?binary-content-id=${fileId}`);
                    const fileData = await fileRes.json();
                    attachmentsHtml += `
                       <div>
                           <small>File ID: ${fileId}</small><br>
                           <img src="data:${fileData.contentType};base64,${fileData.content}" class="msg-img">
                       </div>`;
                }
            }

            const html = `
                <div class="border-bottom p-2">
                    <div class="d-flex justify-content-between">
                        <strong>User: ${msg.authorId}</strong>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editMessage('${msg.id}', '${msg.content}')">수정</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMessage('${msg.id}')">X</button>
                        </div>
                    </div>
                    <p class="mb-1" id="msg-content-${msg.id}">${msg.content}</p>
                    ${attachmentsHtml}
                    <small class="text-muted">${msg.createdAt}</small>
                </div>
            `;
            container.innerHTML += html;
        }
    }

    async function editMessage(id, oldContent) {
        const newContent = prompt("수정할 내용을 입력하세요:", oldContent);
        if(newContent === null || newContent === oldContent) return;

        try {
            const res = await fetch(`${API_BASE}/messages/${id}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ content: newContent })
            });
            if(res.ok) {
                loadMessages();
            } else {
                alert('수정 실패');
            }
        } catch(e) { console.error(e); }
    }

    async function deleteMessage(id) {
        if(!confirm('삭제?')) return;
        await fetch(`${API_BASE}/messages/${id}`, { method: 'DELETE' });
        loadMessages();
    }
</script>
</body>
</html>