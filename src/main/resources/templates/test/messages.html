<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ë©”ì‹œì§€ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .msg-img { max-width: 150px; border-radius: 8px; margin-top: 8px; margin-right: 5px; }
        .msg-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .id-label { font-family: monospace; font-size: 0.8rem; background: #f8f9fa; padding: 2px 4px; border-radius: 4px; }

        /* íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .file-badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            margin: 2px;
            background-color: #e9ecef;
            border-radius: 15px;
            font-size: 0.9rem;
        }
        .file-badge .btn-close {
            margin-left: 8px;
            font-size: 0.7rem;
        }
    </style>
</head>
<body class="p-4">
<div class="container">
    <nav class="mb-4">
        <a href="/test/users" class="btn btn-secondary">ì‚¬ìš©ì ê´€ë¦¬</a>
        <a href="/test/channels" class="btn btn-secondary">ì±„ë„ ê´€ë¦¬</a>
        <a href="/test/messages" class="btn btn-primary">ë©”ì‹œì§€ ê´€ë¦¬</a>
    </nav>

    <h2>3. ë©”ì‹œì§€</h2>

    <div class="row mb-3">
        <div class="col-md-6">
            <label>ë³´ë‚´ëŠ” ì‚¬ëŒ (User ID)</label>
            <input type="text" id="authorId" class="form-control" placeholder="User UUID">
        </div>
        <div class="col-md-6">
            <label>ëŒ€ìƒ ì±„ë„ (Channel ID)</label>
            <div class="input-group">
                <input type="text" id="targetChannelId" class="form-control" placeholder="Channel UUID">
                <button class="btn btn-info" onclick="loadMessages()">ì¡°íšŒ</button>
            </div>
        </div>
    </div>

    <div class="card p-3 mb-4">
        <h5>ë©”ì‹œì§€ ì „ì†¡</h5>

        <textarea id="msgContent" class="form-control mb-2" placeholder="ë‚´ìš© ì…ë ¥"></textarea>

        <div class="mb-2">
            <input type="file" id="msgFiles" class="form-control mb-2" multiple>

            <div id="filePreviewContainer" class="d-flex flex-wrap"></div>
        </div>

        <button class="btn btn-primary w-100" onclick="sendMessage()">ì „ì†¡</button>
    </div>

    <div class="card p-3">
        <h5>ë©”ì‹œì§€ ëª©ë¡</h5>
        <div id="messageList"></div>
    </div>
</div>

<script>
    const API_BASE = '/api';

    document.getElementById('authorId').value = localStorage.getItem('myUserId') || '';

    // ==========================================
    // 1. íŒŒì¼ ì„ íƒ ë° ê´€ë¦¬ ë¡œì§ (Front-end Only)
    // ==========================================
    let pendingFiles = []; // ì „ì†¡ ëŒ€ê¸° ì¤‘ì¸ íŒŒì¼ ë°°ì—´

    // íŒŒì¼ ì„ íƒ ì‹œ ë°°ì—´ì— ì¶”ê°€
    document.getElementById('msgFiles').addEventListener('change', function(e) {
        // ìƒˆë¡œ ì„ íƒëœ íŒŒì¼ë“¤ì„ ê¸°ì¡´ ë°°ì—´ì— í•©ì¹¨ (Array.fromìœ¼ë¡œ ë³€í™˜ í•„ìš”)
        const newFiles = Array.from(e.target.files);
        pendingFiles = pendingFiles.concat(newFiles);

        updateFilePreviewUI();

        // inputì„ ë¹„ì›Œì¤˜ì•¼ ê°™ì€ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí–ˆì„ ë•Œë„ change ì´ë²¤íŠ¸ê°€ ë°œìƒí•¨
        this.value = '';
    });

    // í™”ë©´ ê·¸ë¦¬ê¸°
    function updateFilePreviewUI() {
        const container = document.getElementById('filePreviewContainer');
        container.innerHTML = ''; // ì´ˆê¸°í™”

        pendingFiles.forEach((file, index) => {
            const badge = document.createElement('div');
            badge.className = 'file-badge border';
            badge.innerHTML = `
                <span>ğŸ“ ${file.name} (${(file.size/1024).toFixed(1)} KB)</span>
                <button type="button" class="btn-close" aria-label="Close" onclick="removeFile(${index})"></button>
            `;
            container.appendChild(badge);
        });
    }

    // ê°œë³„ íŒŒì¼ ì‚­ì œ í•¨ìˆ˜ (ì „ì—­ ìŠ¤ì½”í”„ì— ë“±ë¡)
    window.removeFile = function(index) {
        pendingFiles.splice(index, 1); // ë°°ì—´ì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ ìš”ì†Œ ì œê±°
        updateFilePreviewUI(); // í™”ë©´ ê°±ì‹ 
    }


    // ==========================================
    // 2. ì„œë²„ ì „ì†¡ ë¡œì§
    // ==========================================

    // íŒŒì¼ ë‹¤ì¤‘ ì—…ë¡œë“œ API í˜¸ì¶œ
    async function uploadMessageFiles(fileList) {
        const formData = new FormData();
        // Controllerì˜ @RequestPart("files") List<MultipartFile> files ì™€ ë§¤ì¹­
        fileList.forEach(file => formData.append('files', file));

        // BinaryContentControllerì˜ @PostMapping("/messages")
        const res = await fetch(`${API_BASE}/binary-contents/messages`, {
            method: 'POST',
            body: formData
        });

        if (!res.ok) throw new Error("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");
        return await res.json(); // List<UUID> ë°˜í™˜
    }

    async function sendMessage() {
        const content = document.getElementById('msgContent').value;
        const authorId = document.getElementById('authorId').value;
        const channelId = document.getElementById('targetChannelId').value;

        // ìœ íš¨ì„± ê²€ì‚¬: ë‚´ìš©ë„ ì—†ê³  íŒŒì¼ë„ ì—†ìœ¼ë©´ ì¤‘ë‹¨
        if (!content.trim() && pendingFiles.length === 0) {
            alert('ë©”ì‹œì§€ ë‚´ìš©ì´ë‚˜ íŒŒì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            let attachmentIds = [];

            // 1. ëŒ€ê¸° ì¤‘ì¸ íŒŒì¼ì´ ìˆë‹¤ë©´ ì—…ë¡œë“œ ì§„í–‰ (pendingFiles ë°°ì—´ ì‚¬ìš©)
            if (pendingFiles.length > 0) {
                attachmentIds = await uploadMessageFiles(pendingFiles);
            }

            // 2. ë©”ì‹œì§€ ìƒì„± ìš”ì²­ (Pure JSON)
            const requestDto = {
                content: content,
                authorId: authorId,
                channelId: channelId,
                attachmentIds: attachmentIds // ì—…ë¡œë“œëœ UUID ë¦¬ìŠ¤íŠ¸ ì „ì†¡
            };

            const res = await fetch(`${API_BASE}/messages`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(requestDto)
            });

            if(res.ok) {
                // ì„±ê³µ ì‹œ ì´ˆê¸°í™”
                document.getElementById('msgContent').value = '';
                pendingFiles = []; // ë°°ì—´ ë¹„ìš°ê¸°
                updateFilePreviewUI(); // ë¯¸ë¦¬ë³´ê¸° ë¹„ìš°ê¸°
                loadMessages();
            } else {
                alert('ì „ì†¡ ì‹¤íŒ¨: ' + await res.text());
            }
        } catch(e) {
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
        }
    }

    // ==========================================
    // 3. ë©”ì‹œì§€ ì¡°íšŒ ë° ê¸°íƒ€ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    // ==========================================

    async function loadMessages() {
        const chId = document.getElementById('targetChannelId').value;
        if(!chId) return;

        try {
            const res = await fetch(`${API_BASE}/messages?channel-id=${chId}`);
            if(!res.ok) throw new Error(await res.text());
            let messages = await res.json();
            messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

            const container = document.getElementById('messageList');
            container.innerHTML = '';

            for (const msg of messages) {
                let fileHtml = '';
                if(msg.attachmentIds && msg.attachmentIds.length > 0) {
                    for(const fid of msg.attachmentIds) {
                        try {
                            const fRes = await fetch(`${API_BASE}/binary-contents/find?binary-content-id=${fid}`);
                            if(fRes.ok) {
                                const fData = await fRes.json();
                                if(fData.contentType.startsWith('image/')) {
                                    fileHtml += `<img src="data:${fData.contentType};base64,${fData.content}" class="msg-img">`;
                                } else {
                                    fileHtml += `<div class="mt-1 badge bg-light text-dark border">ğŸ“ íŒŒì¼ ID: ${fid}</div>`;
                                }
                            }
                        } catch(e) {}
                    }
                }

                container.innerHTML += `
                    <div class="msg-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="mb-1">
                                    <span class="text-muted small">User:</span> <span class="id-label">${msg.authorId.substring(0,8)}...</span>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary" onclick="editMessage('${msg.id}', '${msg.content || ''}')">ìˆ˜ì •</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteMessage('${msg.id}')">ì‚­ì œ</button>
                            </div>
                        </div>
                        ${msg.content ? `<div class="p-2 bg-light rounded my-2"><strong>${msg.content}</strong></div>` : ''}
                        ${fileHtml}
                        <div class="text-end"><small class="text-muted" style="font-size:0.7rem">${msg.createdAt}</small></div>
                    </div>`;
            }
        } catch(e) { alert('ë¡œë“œ ì‹¤íŒ¨: ' + e.message); }
    }

    async function editMessage(id, old) {
        const next = prompt("ìˆ˜ì •í•  ë‚´ìš©:", old);
        if(next === null || next === old) return;

        // ë‚´ìš©ì´ ë¹„ë©´ ì‚­ì œ í™•ì¸
        if (next.trim() === "") {
            if (confirm("ë‚´ìš©ì„ ì§€ìš°ë©´ ë©”ì‹œì§€ê°€ ì‚­ì œë©ë‹ˆë‹¤. ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                deleteMessage(id);
            }
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/messages/${id}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ content: next })
            });
            if(res.ok) loadMessages();
            else alert('ìˆ˜ì • ì‹¤íŒ¨: ' + await res.text());
        } catch(e) { alert('ì˜¤ë¥˜ ë°œìƒ'); }
    }

    async function deleteMessage(id) {
        if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        await fetch(`${API_BASE}/messages/${id}`, { method: 'DELETE' });
        loadMessages();
    }
</script>
</body>
</html>