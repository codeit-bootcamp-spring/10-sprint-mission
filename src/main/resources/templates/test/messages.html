<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ë©”ì‹œì§€ ê´€ë¦¬ í…ŒìŠ¤íŠ¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .msg-img { max-width: 150px; border-radius: 8px; margin-top: 8px; margin-right: 5px; }
        .msg-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .id-label { font-family: monospace; font-size: 0.8rem; background: #f8f9fa; padding: 2px 4px; border-radius: 4px; }
    </style>
</head>
<body class="p-4">
<div class="container">
    <nav class="mb-4">
        <a href="/test/users" class="btn btn-secondary">ì‚¬ìš©ì ê´€ë¦¬</a>
        <a href="/test/channels" class="btn btn-secondary">ì±„ë„ ê´€ë¦¬</a>
        <a href="/test/messages" class="btn btn-primary">ë©”ì‹œì§€ ê´€ë¦¬</a>
    </nav>

    <h2>3. ë©”ì‹œì§€ & íŒŒì¼ ê´€ë¦¬ (íŒŒì¼ ì—…ë¡œë“œ ë¶„ë¦¬ ì ìš©)</h2>

    <div class="row mb-3">
        <div class="col-md-6">
            <label>ë³´ë‚´ëŠ” ì‚¬ëŒ (User ID)</label>
            <input type="text" id="authorId" class="form-control" placeholder="User UUID">
        </div>
        <div class="col-md-6">
            <label>ëŒ€ìƒ ì±„ë„ (Channel ID)</label>
            <div class="input-group">
                <input type="text" id="targetChannelId" class="form-control" placeholder="Channel UUID">
                <button class="btn btn-info" onclick="loadMessages()">ì¡°íšŒ</button>
            </div>
        </div>
    </div>

    <div class="card p-3 mb-4">
        <h5>ë©”ì‹œì§€ ì „ì†¡</h5>
        <textarea id="msgContent" class="form-control mb-2" placeholder="ë‚´ìš© ì…ë ¥"></textarea>
        <input type="file" id="msgFiles" class="form-control mb-2" multiple>
        <button class="btn btn-primary w-100" onclick="sendMessage()">ì „ì†¡</button>
    </div>

    <div class="card p-3">
        <h5>ë©”ì‹œì§€ ëª©ë¡</h5>
        <div id="messageList"></div>
    </div>
</div>

<script>
    const API_BASE = '/api';

    document.getElementById('authorId').value = localStorage.getItem('myUserId') || '';

    // 1. ë©”ì‹œì§€ íŒŒì¼ ë‹¤ì¤‘ ì—…ë¡œë“œ í—¬í¼
    async function uploadMessageFiles(fileList) {
        const formData = new FormData();
        // Controllerì—ì„œ @RequestPart("files") List<MultipartFile> files ë¡œ ë°›ìŒ
        for (let i = 0; i < fileList.length; i++) {
            formData.append('files', fileList[i]);
        }

        // ë©”ì‹œì§€ ì „ìš© ë‹¤ì¤‘ ì—…ë¡œë“œ API í˜¸ì¶œ
        const res = await fetch(`${API_BASE}/binary-contents/messages`, {
            method: 'POST',
            body: formData
        });

        if (!res.ok) throw new Error("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");
        return await res.json(); // List<UUID> ë°˜í™˜
    }

    // 2. ë©”ì‹œì§€ ì „ì†¡ (Step 1: íŒŒì¼ ì—…ë¡œë“œ -> Step 2: JSON ì „ì†¡)
    async function sendMessage() {
        const content = document.getElementById('msgContent').value;
        const fileInput = document.getElementById('msgFiles');
        const authorId = document.getElementById('authorId').value;
        const channelId = document.getElementById('targetChannelId').value;

        // Validation: ë‚´ìš©ë„ ì—†ê³  íŒŒì¼ë„ ì—†ìœ¼ë©´ ì „ì†¡ ë§‰ìŒ
        if (!content.trim() && fileInput.files.length === 0) {
            alert('ë©”ì‹œì§€ ë‚´ìš©ì´ë‚˜ íŒŒì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            let attachmentIds = [];

            // 1. íŒŒì¼ì´ ìˆë‹¤ë©´ ë¨¼ì € ì—…ë¡œë“œí•´ì„œ UUID ë¦¬ìŠ¤íŠ¸ íšë“
            if (fileInput.files.length > 0) {
                attachmentIds = await uploadMessageFiles(fileInput.files);
            }

            // 2. ë©”ì‹œì§€ ìƒì„± ìš”ì²­ (Pure JSON)
            const requestDto = {
                content: content,
                authorId: authorId,
                channelId: channelId,
                attachmentIds: attachmentIds // List<UUID>
            };

            const res = await fetch(`${API_BASE}/messages`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(requestDto)
            });

            if(res.ok) {
                document.getElementById('msgContent').value = '';
                document.getElementById('msgFiles').value = '';
                loadMessages();
            } else {
                alert('ì „ì†¡ ì‹¤íŒ¨: ' + await res.text());
            }
        } catch(e) {
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
        }
    }

    async function loadMessages() {
        const chId = document.getElementById('targetChannelId').value;
        if(!chId) return;

        try {
            const res = await fetch(`${API_BASE}/messages?channel-id=${chId}`);
            if(!res.ok) throw new Error(await res.text());
            let messages = await res.json();
            messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

            const container = document.getElementById('messageList');
            container.innerHTML = '';

            for (const msg of messages) {
                let fileHtml = '';
                // ì²¨ë¶€íŒŒì¼ ë Œë”ë§
                if(msg.attachmentIds && msg.attachmentIds.length > 0) {
                    for(const fid of msg.attachmentIds) {
                        try {
                            const fRes = await fetch(`${API_BASE}/binary-contents/find?binary-content-id=${fid}`);
                            if(fRes.ok) {
                                const fData = await fRes.json();
                                // ì´ë¯¸ì§€ì¸ ê²½ìš°ë§Œ ë¯¸ë¦¬ë³´ê¸° (í™•ì¥ì/íƒ€ì… ì²´í¬ëŠ” ìƒëµ)
                                if(fData.contentType.startsWith('image/')) {
                                    fileHtml += `<img src="data:${fData.contentType};base64,${fData.content}" class="msg-img">`;
                                } else {
                                    fileHtml += `<div class="mt-1"><small>ğŸ“ íŒŒì¼ ID: ${fid}</small></div>`;
                                }
                            }
                        } catch(e) {}
                    }
                }

                container.innerHTML += `
                    <div class="msg-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="mb-1">
                                    <span class="text-muted small">ID:</span> <span class="id-label">${msg.id}</span>
                                    <span class="text-muted small ms-2">Author:</span> <span class="id-label">${msg.authorId}</span>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary" onclick="editMessage('${msg.id}', '${msg.content || ''}')">ìˆ˜ì •</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteMessage('${msg.id}')">ì‚­ì œ</button>
                            </div>
                        </div>
                        ${msg.content ? `<div class="p-2 bg-light rounded my-2"><strong>${msg.content}</strong></div>` : ''}
                        ${fileHtml}
                        <div class="text-end"><small class="text-muted">${msg.createdAt}</small></div>
                    </div>`;
            }
        } catch(e) { alert('ë¡œë“œ ì‹¤íŒ¨: ' + e.message); }
    }

    async function editMessage(id, old) {
        const next = prompt("ìˆ˜ì •í•  ë‚´ìš©:", old);
        if(next === null || next === old) return;

        if (next.trim() === "") {
            if (confirm("ë‚´ìš©ì„ ì§€ìš°ë©´ ë©”ì‹œì§€ê°€ ì‚­ì œë©ë‹ˆë‹¤. ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                deleteMessage(id);
            }
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/messages/${id}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ content: next })
            });
            if(res.ok) loadMessages();
            else alert('ìˆ˜ì • ì‹¤íŒ¨: ' + await res.text());
        } catch(e) { alert('ì˜¤ë¥˜ ë°œìƒ'); }
    }

    async function deleteMessage(id) {
        if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        await fetch(`${API_BASE}/messages/${id}`, { method: 'DELETE' });
        loadMessages();
    }
</script>
</body>
</html>