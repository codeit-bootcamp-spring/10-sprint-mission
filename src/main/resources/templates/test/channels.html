<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ì±„ë„ ê´€ë¦¬ í…ŒìŠ¤íŠ¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="p-4">
<div class="container">
    <nav class="mb-4">
        <a href="/test/users" class="btn btn-secondary">ì‚¬ìš©ì ê´€ë¦¬</a>
        <a href="/test/channels" class="btn btn-primary">ì±„ë„ ê´€ë¦¬</a>
        <a href="/test/messages" class="btn btn-secondary">ë©”ì‹œì§€ ê´€ë¦¬</a>
    </nav>

    <h2>2. ì±„ë„ ê´€ë¦¬</h2>

    <div class="mb-3">
        <label>í˜„ì¬ ì‚¬ìš©ì ID</label>
        <div class="input-group">
            <input type="text" id="currentUserId" class="form-control" placeholder="UUID ì…ë ¥">
            <button class="btn btn-info" onclick="loadChannels()">ë‚´ ì±„ë„ ì¡°íšŒ</button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card p-3">
                <h5>ê³µê°œ ì±„ë„ ìƒì„±</h5>
                <input type="text" id="pubName" class="form-control mb-2" placeholder="ì±„ë„ ì´ë¦„">
                <input type="text" id="pubDesc" class="form-control mb-2" placeholder="ì„¤ëª…">
                <button class="btn btn-success w-100" onclick="createChannel('PUBLIC')">ìƒì„±</button>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3">
                <h5>ë¹„ê³µê°œ ì±„ë„ ìƒì„±</h5>
                <input type="text" id="privMembers" class="form-control mb-2" placeholder="ë©¤ë²„ UUID (ì½¤ë§ˆë¡œ êµ¬ë¶„)">
                <button class="btn btn-dark w-100" onclick="createChannel('PRIVATE')">ìƒì„±</button>
            </div>
        </div>
    </div>

    <div class="card p-3">
        <h5>ì±„ë„ ëª©ë¡</h5>
        <table class="table mt-2 align-middle">
            <thead class="table-light">
            <tr>
                <th>Channel ID (ì „ì²´)</th>
                <th>Type</th>
                <th>Name / Desc</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody id="channelTableBody"></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="editChannelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì±„ë„ ìˆ˜ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editChannelId">
                <input type="text" class="form-control mb-2" id="editChannelName" placeholder="New Name">
                <input type="text" class="form-control" id="editChannelDesc" placeholder="New Description">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="submitEditChannel()">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api';

    function copyToClipboard(text) {
        const t = document.createElement("textarea");
        t.value = text;
        document.body.appendChild(t);
        t.select();
        document.execCommand('copy');
        document.body.removeChild(t);
        alert('ì±„ë„ IDê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    document.getElementById('currentUserId').value = localStorage.getItem('myUserId') || '';

    async function loadChannels() {
        const userId = document.getElementById('currentUserId').value;
        if(!userId) return alert('ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.');

        try {
            const res = await fetch(`${API_BASE}/channels?user-id=${userId}`);
            if(!res.ok) throw new Error(await res.text());
            const channels = await res.json();
            const tbody = document.getElementById('channelTableBody');
            tbody.innerHTML = '';

            channels.forEach(ch => {
                const editBtn = ch.type === 'PUBLIC'
                    ? `<button class="btn btn-sm btn-outline-secondary" onclick="openEditModal('${ch.id}', '${ch.name}', '${ch.description}')">ìˆ˜ì •</button>`
                    : '';

                tbody.innerHTML += `
                    <tr>
                        <td>
                            <code style="font-size: 0.85rem;">${ch.id}</code>
                            <button class="btn btn-sm btn-light p-1" onclick="copyToClipboard('${ch.id}')" title="ID ë³µì‚¬">ğŸ“‹</button>
                        </td>
                        <td><span class="badge ${ch.type === 'PUBLIC' ? 'bg-primary' : 'bg-dark'}">${ch.type}</span></td>
                        <td><strong>${ch.name || 'ë¹„ê³µê°œ'}</strong><br><small>${ch.description || ''}</small></td>
                        <td>
                            ${editBtn}
                            <button class="btn btn-sm btn-danger" onclick="deleteChannel('${ch.id}')">ì‚­ì œ</button>
                        </td>
                    </tr>`;
            });
        } catch(e) {
            alert('ì±„ë„ ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
        }
    }

    async function createChannel(type) {
        let body = { type: type };
        if(type === 'PUBLIC') {
            body.name = document.getElementById('pubName').value;
            body.description = document.getElementById('pubDesc').value;
        } else {
            const current = document.getElementById('currentUserId').value;
            const members = document.getElementById('privMembers').value.split(',').map(s => s.trim()).filter(s => s);
            if(current && !members.includes(current)) members.push(current);
            body.memberIds = members;
        }

        try {
            const res = await fetch(`${API_BASE}/channels`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            if(res.ok) {
                loadChannels();
                document.getElementById('pubName').value = '';
                document.getElementById('pubDesc').value = '';
                document.getElementById('privMembers').value = '';
            } else {
                alert('ì±„ë„ ìƒì„± ì‹¤íŒ¨: ' + await res.text());
            }
        } catch(e) {
            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function openEditModal(id, name, desc) {
        document.getElementById('editChannelId').value = id;
        document.getElementById('editChannelName').value = name;
        document.getElementById('editChannelDesc').value = desc;
        new bootstrap.Modal(document.getElementById('editChannelModal')).show();
    }

    async function submitEditChannel() {
        const id = document.getElementById('editChannelId').value;
        const body = {
            newName: document.getElementById('editChannelName').value,
            newDescription: document.getElementById('editChannelDesc').value
        };
        try {
            const res = await fetch(`${API_BASE}/channels/${id}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            if(res.ok) {
                location.reload();
            } else {
                alert('ìˆ˜ì • ì‹¤íŒ¨: ' + await res.text());
            }
        } catch(e) {
            alert('ì˜¤ë¥˜ ë°œìƒ');
        }
    }

    async function deleteChannel(id) {
        if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            const res = await fetch(`${API_BASE}/channels/${id}`, { method: 'DELETE' });
            if(res.ok) loadChannels();
            else alert('ì‚­ì œ ì‹¤íŒ¨: ' + await res.text());
        } catch(e) {
            alert('ì˜¤ë¥˜ ë°œìƒ');
        }
    }
</script>
</body>
</html>