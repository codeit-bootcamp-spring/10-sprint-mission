<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>채널 관리 테스트</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="p-4">
<div class="container">
    <nav class="mb-4">
        <a href="/test/users" class="btn btn-secondary">사용자 관리</a>
        <a href="/test/channels" class="btn btn-primary">채널 관리</a>
        <a href="/test/messages" class="btn btn-secondary">메시지 관리</a>
    </nav>

    <h2>2. 채널 관리</h2>

    <div class="mb-3">
        <label>현재 사용자 ID (User Management에서 Copy 해오세요)</label>
        <input type="text" id="currentUserId" class="form-control" placeholder="UUID 입력">
        <button class="btn btn-sm btn-info mt-1" onclick="loadChannels()">내 채널 조회</button>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card p-3">
                <h5>공개 채널 생성</h5>
                <input type="text" id="pubName" class="form-control mb-2" placeholder="채널 이름">
                <input type="text" id="pubDesc" class="form-control mb-2" placeholder="설명">
                <button class="btn btn-success" onclick="createChannel('PUBLIC')">생성</button>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3">
                <h5>비공개 채널 생성</h5>
                <input type="text" id="privMembers" class="form-control mb-2" placeholder="멤버 UUID (콤마로 구분)">
                <small class="text-muted">예: uuid1, uuid2</small>
                <button class="btn btn-dark mt-2" onclick="createChannel('PRIVATE')">생성</button>
            </div>
        </div>
    </div>

    <div class="card p-3">
        <h5>채널 목록 (GET /api/channels?user-id=...)</h5>
        <table class="table mt-2">
            <thead>
            <tr>
                <th>Channel ID</th>
                <th>Type</th>
                <th>Name / Desc</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody id="channelTableBody"></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="editChannelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">공개 채널 수정 (PATCH)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editChannelId">
                <div class="mb-2">
                    <label>새 채널 이름</label>
                    <input type="text" class="form-control" id="editChannelName">
                </div>
                <div class="mb-2">
                    <label>새 설명</label>
                    <input type="text" class="form-control" id="editChannelDesc">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" onclick="submitEditChannel()">수정하기</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api';

    document.getElementById('currentUserId').value = localStorage.getItem('myUserId') || '';

    async function createChannel(type) {
        let body = { type: type };

        if(type === 'PUBLIC') {
            body.name = document.getElementById('pubName').value;
            body.description = document.getElementById('pubDesc').value;
        } else {
            const raw = document.getElementById('privMembers').value;
            const current = document.getElementById('currentUserId').value;
            const members = raw.split(',').map(s => s.trim()).filter(s => s);
            if(current && !members.includes(current)) members.push(current);
            body.memberIds = members;
        }

        try {
            const res = await fetch(`${API_BASE}/channels`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            if(res.ok) { alert('생성 완료'); loadChannels(); }
            else alert(await res.text());
        } catch(e) { console.error(e); }
    }

    async function loadChannels() {
        const userId = document.getElementById('currentUserId').value;
        if(!userId) { alert('사용자 ID를 입력하세요'); return; }

        const res = await fetch(`${API_BASE}/channels?user-id=${userId}`);
        const channels = await res.json();

        const tbody = document.getElementById('channelTableBody');
        tbody.innerHTML = '';
        channels.forEach(ch => {
            // PUBLIC 채널만 수정 가능하도록 버튼 처리
            const editBtn = ch.type === 'PUBLIC'
                ? `<button class="btn btn-sm btn-secondary" onclick="openEditModal('${ch.id}', '${ch.name}', '${ch.description}')">수정</button>`
                : '';

            tbody.innerHTML += `
                <tr>
                    <td><small>${ch.id}</small> <button class="btn btn-xs btn-outline-secondary" onclick="navigator.clipboard.writeText('${ch.id}')">Copy</button></td>
                    <td>${ch.type}</td>
                    <td>${ch.name || '비공개'} <br><small>${ch.description || ''}</small></td>
                    <td>
                        ${editBtn}
                        <button class="btn btn-sm btn-danger" onclick="deleteChannel('${ch.id}')">삭제</button>
                    </td>
                </tr>
            `;
        });
    }

    function openEditModal(id, name, desc) {
        document.getElementById('editChannelId').value = id;
        document.getElementById('editChannelName').value = name === 'null' ? '' : name;
        document.getElementById('editChannelDesc').value = desc === 'null' ? '' : desc;
        new bootstrap.Modal(document.getElementById('editChannelModal')).show();
    }

    async function submitEditChannel() {
        const id = document.getElementById('editChannelId').value;
        const body = {
            newName: document.getElementById('editChannelName').value,
            newDescription: document.getElementById('editChannelDesc').value
        };

        try {
            const res = await fetch(`${API_BASE}/channels/${id}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            if(res.ok) {
                alert('수정 완료');
                loadChannels();
                location.reload();
            } else {
                alert('수정 실패: ' + await res.text());
            }
        } catch(e) { console.error(e); }
    }

    async function deleteChannel(id) {
        if(!confirm('삭제하시겠습니까?')) return;
        await fetch(`${API_BASE}/channels/${id}`, { method: 'DELETE' });
        loadChannels();
    }
</script>
</body>
</html>