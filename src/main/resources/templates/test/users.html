<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ì‚¬ìš©ì ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
        }
        .preview-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ced4da;
            background-color: #f8f9fa;
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            color: white;
        }
        .online { background-color: #4CAF50; }
        .offline { background-color: #9e9e9e; }
        .table align-middle td { vertical-align: middle; }
    </style>
</head>
<body class="p-4">
<div class="container">
    <nav class="mb-4">
        <a href="/test/users" class="btn btn-primary">ì‚¬ìš©ì ê´€ë¦¬</a>
        <a href="/test/channels" class="btn btn-secondary">ì±„ë„ ê´€ë¦¬</a>
        <a href="/test/messages" class="btn btn-secondary">ë©”ì‹œì§€ ê´€ë¦¬</a>
    </nav>

    <h2>1. ì‚¬ìš©ì ê´€ë¦¬</h2>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card p-3">
                <h5>íšŒì›ê°€ì…</h5>
                <form id="signupForm">
                    <input type="text" class="form-control mb-2" id="signupName" placeholder="Username" required>
                    <input type="email" class="form-control mb-2" id="signupEmail" placeholder="Email" required>
                    <input type="password" class="form-control mb-2" id="signupPw" placeholder="Password" required>
                    <label class="form-label small text-muted">í”„ë¡œí•„ ì´ë¯¸ì§€ (ì„ íƒ)</label>
                    <input type="file" class="form-control mb-2" id="signupFile" accept="image/*">
                    <button type="button" class="btn btn-success w-100" onclick="signup()">ê°€ì…í•˜ê¸°</button>
                </form>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card p-3">
                <h5>ë¡œê·¸ì¸</h5>
                <input type="text" class="form-control mb-2" id="loginName" placeholder="Username">
                <input type="password" class="form-control mb-2" id="loginPw" placeholder="Password">
                <button type="button" class="btn btn-primary w-100" onclick="login()">ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
                <div id="loginResult" class="mt-2 text-primary text-center"></div>
            </div>
        </div>
    </div>

    <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>ì‚¬ìš©ì ëª©ë¡</h5>
            <button class="btn btn-sm btn-info" onclick="loadUsers()">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th>í”„ë¡œí•„</th>
                <th>ì‚¬ìš©ì ì •ë³´</th>
                <th>ID (UUID)</th>
                <th>ìƒíƒœ</th>
                <th>ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody id="userTableBody">
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">

                <div class="mb-4 text-center">
                    <label class="form-label d-block fw-bold">í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì •</label>
                    <div class="mb-2 position-relative d-inline-block">
                        <img id="editProfilePreview" src="/default-avatar.jpg" class="preview-avatar">
                        <div id="previewBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary">
                            ê¸°ì¡´
                        </div>
                    </div>

                    <div class="d-flex justify-content-center gap-2 mt-2">
                        <input type="file" id="editFile" accept="image/*" style="display:none">

                        <button class="btn btn-sm btn-outline-primary" onclick="document.getElementById('editFile').click()">
                            ğŸ“· ì‚¬ì§„ ë³€ê²½
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="markProfileDeleted()">
                            ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetProfileChange()">
                            â†º ë˜ëŒë¦¬ê¸°
                        </button>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" id="editUsername">
                </div>
                <div class="mb-2">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="editEmail">
                </div>
                <div class="mb-2">
                    <label class="form-label">Password (ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥)</label>
                    <input type="password" class="form-control" id="editPassword">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" onclick="submitEditUser()">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api';

    // ==========================================
    // 1. í”„ë¡œí•„ ì´ë¯¸ì§€ ìƒíƒœ ê´€ë¦¬ ë¡œì§ (State Machine)
    // ==========================================
    let tempProfileState = 'ORIGINAL'; // 'ORIGINAL' | 'DELETE' | 'NEW'
    let tempFile = null;
    let originalProfileUrl = ''; // ëª¨ë‹¬ ì—´ì—ˆì„ ë•Œì˜ ê¸°ì¡´ ì´ë¯¸ì§€ URL ê¸°ì–µ

    // ëª¨ë‹¬ ì—´ê¸°
    function openEditModal(userId, currentUsername, currentEmail) {
        // 1. ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('editUserId').value = userId;
        document.getElementById('editUsername').value = currentUsername;
        document.getElementById('editEmail').value = currentEmail;
        document.getElementById('editPassword').value = '';
        document.getElementById('editFile').value = '';

        // 2. ìƒíƒœ ì´ˆê¸°í™”
        tempProfileState = 'ORIGINAL';
        tempFile = null;

        // 3. í˜„ì¬ ëª©ë¡ì— ë–  ìˆëŠ” ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì™€ì„œ 'ì›ë³¸'ìœ¼ë¡œ ê¸°ì–µ (UX ìµœì í™”)
        const userImg = document.getElementById(`img-${userId}`);
        originalProfileUrl = userImg ? userImg.src : '/default-avatar.jpg';

        // 4. UI ì—…ë°ì´íŠ¸ ë° ëª¨ë‹¬ í‘œì‹œ
        updatePreviewUI();
        new bootstrap.Modal(document.getElementById('editUserModal')).show();
    }

    // [ì´ë²¤íŠ¸] íŒŒì¼ ì„ íƒ ì‹œ -> NEW ìƒíƒœë¡œ ë³€ê²½
    document.getElementById('editFile').onchange = function(e) {
        if (e.target.files.length > 0) {
            tempProfileState = 'NEW';
            tempFile = e.target.files[0];
            // ë¸Œë¼ìš°ì € ë‚´ë¶€ ì„ì‹œ URLë¡œ ë¯¸ë¦¬ë³´ê¸°
            const previewUrl = URL.createObjectURL(tempFile);
            updatePreviewUI(previewUrl);
        }
    };

    // [ì´ë²¤íŠ¸] ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ -> DELETE ìƒíƒœë¡œ ë³€ê²½
    function markProfileDeleted() {
        tempProfileState = 'DELETE';
        tempFile = null;
        document.getElementById('editFile').value = '';
        updatePreviewUI();
    }

    // [ì´ë²¤íŠ¸] ë˜ëŒë¦¬ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ -> ORIGINAL ìƒíƒœë¡œ ë³µêµ¬
    function resetProfileChange() {
        tempProfileState = 'ORIGINAL';
        tempFile = null;
        document.getElementById('editFile').value = '';
        updatePreviewUI();
    }

    // [UI] ìƒíƒœì— ë”°ë¥¸ ë¯¸ë¦¬ë³´ê¸° ë° ë±ƒì§€ ì—…ë°ì´íŠ¸
    function updatePreviewUI(newUrl) {
        const img = document.getElementById('editProfilePreview');
        const badge = document.getElementById('previewBadge');

        if (tempProfileState === 'ORIGINAL') {
            img.src = originalProfileUrl;
            badge.innerText = 'ê¸°ì¡´ ìœ ì§€';
            badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary';
        } else if (tempProfileState === 'DELETE') {
            img.src = '/default-avatar.jpg'; // ì‚­ì œ ì‹œ ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë³´ì—¬ì¤Œ
            badge.innerText = 'ì‚­ì œ ì˜ˆì •';
            badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger';
        } else if (tempProfileState === 'NEW') {
            img.src = newUrl;
            badge.innerText = 'ìƒˆ ì´ë¯¸ì§€';
            badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary';
        }
    }

    // ==========================================
    // 2. ì„œë²„ í†µì‹  ë¡œì§ (API í˜¸ì¶œ)
    // ==========================================

    // í”„ë¡œí•„ ì´ë¯¸ì§€ ì „ìš© ì—…ë¡œë“œ API
    async function uploadProfileImage(file) {
        const formData = new FormData();
        formData.append('file', file); // Controllerì˜ @RequestPart("file") ì´ë¦„ê³¼ ì¼ì¹˜ í•„ìˆ˜

        // ê²½ë¡œ í™•ì¸: BinaryContentControllerì˜ @PostMapping("/profile")
        const res = await fetch(`${API_BASE}/binary-contents/profile`, {
            method: 'POST',
            body: formData
        });
        if (!res.ok) throw new Error(await res.text());
        return await res.json(); // UUID ë°˜í™˜ ({id: "..."})
    }

    // ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • (ìµœì¢… ì €ì¥)
    async function submitEditUser() {
        const userId = document.getElementById('editUserId').value;
        let finalProfileId = null; // ë³€ê²½ ì—†ìœ¼ë©´ null
        let finalIsDeleted = false; // ì‚­ì œ ì•„ë‹ˆë©´ false

        try {
            // í˜„ì¬ ìƒíƒœì— ë”°ë¼ ì „ì†¡í•  ë°ì´í„° ê²°ì •
            if (tempProfileState === 'NEW' && tempFile) {
                // 1. ìƒˆ íŒŒì¼ì´ë©´ ë¨¼ì € ì—…ë¡œë“œí•´ì„œ UUIDë¥¼ ë°›ì•„ì˜´
                finalProfileId = await uploadProfileImage(tempFile);
            } else if (tempProfileState === 'DELETE') {
                // 2. ì‚­ì œ ìƒíƒœë©´ í”Œë˜ê·¸ë¥¼ trueë¡œ ì„¤ì •
                finalIsDeleted = true;
            }
            // ORIGINAL ìƒíƒœë©´ ë‘˜ ë‹¤ ê¸°ë³¸ê°’(null, false)ì´ë¯€ë¡œ ì„œë²„ëŠ” ì•„ë¬´ê²ƒë„ ì•ˆ í•¨

            const updateRequest = {
                newUsername: document.getElementById('editUsername').value || null,
                newEmail: document.getElementById('editEmail').value || null,
                newPassword: document.getElementById('editPassword').value || null,
                profileId: finalProfileId,    // ìƒˆ íŒŒì¼ UUID (ì—†ìœ¼ë©´ null)
                isProfileDeleted: finalIsDeleted // ì‚­ì œ ìš”ì²­ ì—¬ë¶€
            };

            const res = await fetch(`${API_BASE}/users/${userId}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(updateRequest)
            });

            if(res.ok) {
                alert('ìˆ˜ì • ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            } else {
                alert('ìˆ˜ì • ì‹¤íŒ¨: ' + await res.text());
            }
        } catch(e) {
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
        }
    }

    // ==========================================
    // 3. ì¡°íšŒ ë° ê¸°íƒ€ ê¸°ë³¸ ë¡œì§
    // ==========================================

    // ì´ë¯¸ì§€ ë¡œë“œ í—¬í¼ (binary-content API ì‚¬ìš©)
    async function fetchUserProfile(profileId) {
        if (!profileId) return '/default-avatar.jpg';
        try {
            const response = await fetch(`${API_BASE}/binary-contents/find?binary-content-id=${profileId}`);
            if (!response.ok) throw new Error();
            const profile = await response.json();
            // Base64 ë°ì´í„°ë¥¼ ì´ë¯¸ì§€ ì†ŒìŠ¤ë¡œ ë³€í™˜
            return `data:${profile.contentType};base64,${profile.content}`;
        } catch (error) {
            return '/default-avatar.jpg';
        }
    }

    // [ì¶”ê°€] ID ë³µì‚¬ë¥¼ ìœ„í•œ í—¬í¼ í•¨ìˆ˜
    function copyToClipboard(text) {
        const t = document.createElement("textarea");
        t.value = text;
        document.body.appendChild(t);
        t.select();
        document.execCommand('copy');
        document.body.removeChild(t);
        alert('IDê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
    async function loadUsers() {
        try {
            const res = await fetch(`${API_BASE}/users/findAll`);
            const users = await res.json();
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';

            for (const u of users) {
                // ê° ì‚¬ìš©ìì˜ í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ë¹„ë™ê¸°ë¡œ ê°€ì ¸ì˜´
                const profileUrl = await fetchUserProfile(u.profileId);
                const statusClass = u.Online ? 'online' : 'offline';
                const statusText = u.Online ? 'Online' : 'Offline';

                // ID ë³µì‚¬ ë²„íŠ¼ ì¶”ê°€
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <img src="${profileUrl}" id="img-${u.id}" class="user-avatar" alt="profile">
                        </td>
                        <td>
                            <div class="fw-bold">${u.username}</div>
                            <div class="text-muted small">${u.email}</div>
                        </td>
                        <td>
                            <code class="small text-muted">${u.id}</code>
                            <button class="btn btn-sm btn-light p-1" onclick="copyToClipboard('${u.id}')">ğŸ“‹</button>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <button class="btn btn-sm btn-link text-decoration-none p-0 ms-1" onclick="updateStatus('${u.id}')">ğŸ”„</button>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary"
                                    onclick="openEditModal('${u.id}', '${u.username}', '${u.email}')">ìˆ˜ì •</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${u.id}')">ì‚­ì œ</button>
                            </div>
                        </td>
                    </tr>`;
            }
        } catch (e) {
            console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
            alert('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // íšŒì›ê°€ì…
    async function signup() {
        try {
            const fileInput = document.getElementById('signupFile');
            let profileId = null;

            // 1. íŒŒì¼ì´ ìˆë‹¤ë©´ ë¨¼ì € ì—…ë¡œë“œ
            if (fileInput.files.length > 0) {
                profileId = await uploadProfileImage(fileInput.files[0]);
            }

            // 2. íšŒì›ê°€ì… ìš”ì²­
            const requestDto = {
                username: document.getElementById('signupName').value,
                email: document.getElementById('signupEmail').value,
                password: document.getElementById('signupPw').value,
                profileId: profileId
            };

            const res = await fetch(`${API_BASE}/users/signup`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(requestDto)
            });

            if(res.ok) {
                alert('ê°€ì… ì„±ê³µ!');
                document.getElementById('signupForm').reset();
                loadUsers();
            }
            else alert('ê°€ì… ì‹¤íŒ¨: ' + await res.text());
        } catch(e) {
            alert('ì˜¤ë¥˜: ' + e.message);
        }
    }

    // ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
    async function login() {
        const data = {
            username: document.getElementById('loginName').value,
            password: document.getElementById('loginPw').value
        };
        try {
            const res = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) {
                const result = await res.json();
                document.getElementById('loginResult').innerText = `ë¡œê·¸ì¸ ì„±ê³µ (ID: ${result.id})`;
                localStorage.setItem('myUserId', result.id); // ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì €ì¥
            } else {
                alert('ë¡œê·¸ì¸ ì‹¤íŒ¨');
            }
        } catch(e) { alert('í†µì‹  ì˜¤ë¥˜'); }
    }

    // ì‚¬ìš©ì ì‚­ì œ
    async function deleteUser(id) {
        if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            const res = await fetch(`${API_BASE}/users/${id}`, { method: 'DELETE' });
            if(res.ok) loadUsers();
            else alert('ì‚­ì œ ì‹¤íŒ¨: ' + await res.text());
        } catch(e) { alert('ì˜¤ë¥˜ ë°œìƒ'); }
    }

    // í™œë™ ìƒíƒœ ê°±ì‹  (í…ŒìŠ¤íŠ¸ìš©)
    async function updateStatus(id) {
        await fetch(`${API_BASE}/users/${id}/status`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userid: id, newLastActiveAt: new Date().toISOString() })
        });
        loadUsers();
    }

    // ì´ˆê¸° ì‹¤í–‰
    loadUsers();
</script>
</body>
</html>